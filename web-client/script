// Конфигурация - ВАШ СЕРВЕР
// Сервер авторизации (от одного человека)
const AUTH_SERVER = 'http://26.111.149.201:4000'; // или другой порт

// Сервер основной логики (от другого сокомандника)
const API_SERVER = 'http://26.1.150.131:3415';
const API_BASE = `${API_SERVER}/api`;
const SESSION_KEY = 'test_session';

// Состояние
let state = {
    status: 'unknown',
    userId: null,
    token: null,
    currentCourse: null,
    currentTest: null,
    questions: [],
    currentQuestion: 0,
    answers: {}
};

// ========== ИНИЦИАЛИЗАЦИЯ ==========
document.addEventListener('DOMContentLoaded', init);

function init() {
    checkSession();
    document.getElementById('authCode').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') submitCode();
    });
}

// ========== СЕССИЯ ==========
function checkSession() {
    const session = localStorage.getItem(SESSION_KEY);
    if (!session) return updateState('unknown');
    
    try {
        const data = JSON.parse(session);
        state.token = data.token;
        state.userId = data.userId;
        
        // Проверяем токен
        getUser(data.userId).then(user => {
            state.status = 'authorized';
            updateState('authorized');
            loadUserData();
        }).catch(() => {
            updateState('unknown');
        });
    } catch {
        updateState('unknown');
    }
}

function updateState(newStatus) {
    state.status = newStatus;
    document.getElementById('userStatus').textContent = `Статус: ${newStatus === 'unknown' ? 'Неизвестный' : newStatus === 'anonymous' ? 'Анонимный' : 'Авторизованный'}`;
    
    // Показать нужное состояние
    document.querySelectorAll('.state').forEach(el => el.classList.remove('active'));
    document.getElementById(`state${capitalize(newStatus)}`).classList.add('active');
}

function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

// ========== АВТОРИЗАЦИЯ ==========
async function startAuth(provider) {
    try {
        console.log(`Начинаем авторизацию через ${provider} на сервере ${AUTH_SERVER}`);
        
        if (provider === 'github' || provider === 'yandex') {
            // ВАЖНОЕ ИСПРАВЛЕНИЕ: Убрал лишнее поле provider из тела запроса
            // Получаем токен сессии
            const loginToken = state.token || 
                (localStorage.getItem(SESSION_KEY) ? 
                    JSON.parse(localStorage.getItem(SESSION_KEY)).token : null);
            
            console.log('Токен сессии:', loginToken ? 'есть' : 'нет');
        
            const response = await fetch(`${AUTH_SERVER}/auth/${provider}/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    provider: provider,
                    loginToken:"test"
                })
            });
            
            console.log('Статус ответа:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('Ответ сервера:', data);
                
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    alert('Сервер не вернул URL для редиректа');
                }
            } else {
                const errorText = await response.text();
                console.error('Ошибка сервера:', response.status, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
        } else if (provider === 'code') {
            showCodeModal();
        }
    } catch (error) {
        console.error('Полная ошибка авторизации:', error);
        alert(`Ошибка авторизации: ${error.message}`);
    }
}

function showCodeModal() {
    document.getElementById('codeModal').style.display = 'flex';
    document.getElementById('authCode').focus();
}

function hideCodeModal() {
    document.getElementById('codeModal').style.display = 'none';
    document.getElementById('authCode').value = '';
}

async function submitCode() {
    const code = document.getElementById('authCode').value;
    if (code.length !== 6) return alert('Введите 6 цифр');
    
    try {
        // Отправляем код на сервер
        const response = await fetch(`${API_BASE}/auth/code`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({code})
        });
        
        if (response.ok) {
            const data = await response.json();
            state.token = data.token;
            state.userId = data.userId;
            
            localStorage.setItem(SESSION_KEY, JSON.stringify({
                token: data.token,
                userId: data.userId
            }));
            
            hideCodeModal();
            updateState('authorized');
            loadUserData();
        } else {
            alert('Неверный код');
        }
    } catch {
        alert('Ошибка сервера');
    }
}

function cancelAuth() {
    localStorage.removeItem(SESSION_KEY);
    updateState('unknown');
}

// ========== API ФУНКЦИИ ==========

// Общая функция для API вызовов
async function apiCall(method, endpoint, data = null) {
    const url = `${API_BASE}${endpoint}`;
    const options = {
        method,
        headers: {}
    };
    
    if (state.token) {
        options.headers['Authorization'] = `Bearer ${state.token}`;
    }
    
    if (data) {
        options.headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(data);
    }
    
    try {
        const response = await fetch(url, options);
        if (!response.ok) {
            if (response.status === 401) {
                // Токен истек
                localStorage.removeItem(SESSION_KEY);
                updateState('unknown');
                alert('Сессия истекла. Войдите снова.');
                return null;
            }
            throw new Error(`HTTP ${response.status}`);
        }
        return await response.json();
    } catch (error) {
        console.error('API error:', error);
        throw error;
    }
}

// Все 15 endpoints

// 1. Все пользователи
async function getAllUsers() {
    return apiCall('GET', '/users');
}

// 2. Конкретный пользователь
async function getUser(userId) {
    return apiCall('GET', `/user/${userId}`);
}

async function updateUser(userId, data) {
    return apiCall('PATCH', `/user/${userId}`, data);
}

// 3. Курсы пользователя
async function getUserCourses(userId) {
    return apiCall('GET', `/course/user/${userId}`);
}

// 4. Все курсы
async function getAllCourses() {
    return apiCall('GET', '/courses');
}

// 5. Конкретный курс
async function getCourse(courseId) {
    return apiCall('GET', `/course/${courseId}`);
}

async function updateCourse(courseId, data) {
    return apiCall('PATCH', `/course/${courseId}`, data);
}

async function deleteCourse(courseId) {
    return apiCall('DELETE', `/course/${courseId}`);
}

// 6. Тесты курса
async function getCourseTests(courseId) {
    return apiCall('GET', `/course/${courseId}/test`);
}

async function createTest(courseId, name) {
    return apiCall('POST', `/course/${courseId}/test`, {name});
}

// 7. Конкретный тест
async function getTestQuestions(courseId, testId) {
    return apiCall('GET', `/course/${courseId}/test/${testId}`);
}

async function deleteTest(courseId, testId) {
    return apiCall('DELETE', `/course/${courseId}/test/${testId}`);
}

// 8. Запись/отчисление
async function enrollToCourse(courseId, userId) {
    return apiCall('POST', `/course/${courseId}/user/${userId}`);
}

async function leaveCourse(courseId, userId) {
    return apiCall('DELETE', `/course/${courseId}/user/${userId}`);
}

// 9. Создать курс
async function createCourse(data) {
    return apiCall('POST', '/course', data);
}

// 10. Вопросы теста
async function getTest(testId) {
    return apiCall('GET', `/test/${testId}`);
}

// 11. Работа с вопросом
async function createQuestion(data) {
    return apiCall('POST', '/question', data);
}

// 12. Вопрос в тесте
async function addQuestionToTest(testId, questionId) {
    return apiCall('POST', `/test/${testId}/question/${questionId}`);
}

// 13. Оценка за тест
async function getUserTestScore(courseId, testId, userId) {
    return apiCall('GET', `/course/${courseId}/test/${testId}/user/${userId}`);
}

// 14. Участники теста
async function getTestParticipants(courseId, testId) {
    return apiCall('GET', `/course/${courseId}/test/${testId}`);
}

// 15. Ответы пользователя
async function getUserTestAnswers(testId, userId) {
    return apiCall('GET', `/test/${testId}/user/${userId}`);
}

// ========== ИНТЕРФЕЙС ==========
function showSection(sectionName) {
    document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
    document.getElementById(`section${capitalize(sectionName)}`).classList.add('active');
    
    document.querySelectorAll('.nav button').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.nav button[onclick*="${sectionName}"]`).classList.add('active');
    
    switch(sectionName) {
        case 'courses':
            loadUserCourses();
            break;
        case 'allcourses':
            loadAllCourses();
            break;
        case 'tests':
            if (state.currentCourse) loadCourseTests(state.currentCourse);
            break;
        case 'results':
            loadUserResults();
            break;
        case 'profile':
            loadProfile();
            break;
        case 'admin':
            loadAdminPanel();
            break;
    }
}

async function loadUserData() {
    try {
        const user = await getUser(state.userId);
        document.getElementById('userInfo').textContent = `Пользователь: ${user.name || user.email || 'ID: ' + state.userId}`;
    } catch (error) {
        console.error('Ошибка загрузки данных пользователя:', error);
    }
}

async function loadUserCourses() {
    const container = document.getElementById('coursesList');
    container.innerHTML = 'Загрузка...';
    
    try {
        const courses = await getUserCourses(state.userId);
        
        if (!courses || courses.length === 0) {
            container.innerHTML = '<div class="card">Нет курсов</div>';
            return;
        }
        
        container.innerHTML = courses.map(course => `
            <div class="card">
                <h3>${course.name}</h3>
                <p>${course.description || ''}</p>
                <button onclick="viewCourse('${course.id}')">Тесты</button>
                <button onclick="leaveCourseAction('${course.id}')">Отписаться</button>
            </div>
        `).join('');
    } catch (error) {
        container.innerHTML = '<div class="card">Ошибка загрузки</div>';
    }
}

async function viewCourse(courseId) {
    state.currentCourse = courseId;
    
    try {
        const course = await getCourse(courseId);
        document.getElementById('courseInfo').innerHTML = `
            <div class="card">
                <h3>${course.name}</h3>
                <p>${course.description || ''}</p>
            </div>
        `;
    } catch (error) {
        console.error('Ошибка загрузки курса:', error);
    }
    
    loadCourseTests(courseId);
    showSection('tests');
}

async function loadCourseTests(courseId) {
    const container = document.getElementById('testsList');
    container.innerHTML = 'Загрузка...';
    
    try {
        const tests = await getCourseTests(courseId);
        
        if (!tests || tests.length === 0) {
            container.innerHTML = '<div class="card">Нет тестов</div>';
            return;
        }
        
        container.innerHTML = tests.map(test => `
            <div class="card">
                <h3>${test.name}</h3>
                <p>Вопросов: ${test.questionCount || 0}</p>
                <button onclick="startTest('${courseId}', '${test.id}')">Начать тест</button>
                <button onclick="viewTestResults('${courseId}', '${test.id}')">Результаты</button>
            </div>
        `).join('');
    } catch (error) {
        container.innerHTML = '<div class="card">Ошибка загрузки</div>';
    }
}

async function loadAllCourses() {
    const container = document.getElementById('allCoursesList');
    container.innerHTML = 'Загрузка...';
    
    try {
        const allCourses = await getAllCourses();
        const userCourses = await getUserCourses(state.userId);
        const userCourseIds = userCourses.map(c => c.id);
        
        if (!allCourses || allCourses.length === 0) {
            container.innerHTML = '<div class="card">Нет курсов</div>';
            return;
        }
        
        container.innerHTML = allCourses.map(course => `
            <div class="card">
                <h3>${course.name}</h3>
                <p>${course.description || ''}</p>
                ${userCourseIds.includes(course.id) 
                    ? '<button disabled>Записан</button>'
                    : `<button onclick="enrollToCourseAction('${course.id}')">Записаться</button>`
                }
            </div>
        `).join('');
    } catch (error) {
        container.innerHTML = '<div class="card">Ошибка загрузки</div>';
    }
}

async function enrollToCourseAction(courseId) {
    try {
        await enrollToCourse(courseId, state.userId);
        alert('Вы записались на курс');
        loadAllCourses();
        loadUserCourses();
    } catch (error) {
        alert('Ошибка записи на курс');
    }
}

async function leaveCourseAction(courseId) {
    if (!confirm('Отписаться от курса?')) return;
    
    try {
        await leaveCourse(courseId, state.userId);
        alert('Вы отписались от курса');
        loadUserCourses();
    } catch (error) {
        alert('Ошибка');
    }
}

// ========== ТЕСТИРОВАНИЕ ==========
async function startTest(courseId, testId) {
    state.currentCourse = courseId;
    state.currentTest = testId;
    state.currentQuestion = 0;
    state.answers = {};
    
    try {
        state.questions = await getTestQuestions(courseId, testId);
        
        showSection('test');
        loadQuestion();
    } catch (error) {
        alert('Ошибка загрузки теста');
    }
}

function loadQuestion() {
    if (state.currentQuestion >= state.questions.length) {
        finishTest();
        return;
    }
    
    const question = state.questions[state.currentQuestion];
    document.getElementById('questionCounter').textContent = 
        `Вопрос ${state.currentQuestion + 1}/${state.questions.length}`;
    
    document.getElementById('testContent').innerHTML = `
        <h3>${question.text}</h3>
        <div>
            ${(question.options || []).map((option, index) => `
                <div class="option ${state.answers[question.id] === index ? 'selected' : ''}" 
                     onclick="selectAnswer(${index})">
                    ${String.fromCharCode(65 + index)}. ${option}
                </div>
            `).join('')}
        </div>
        <div>
            ${state.currentQuestion > 0 ? '<button onclick="prevQuestion()">Назад</button>' : ''}
            <button onclick="nextQuestion()">
                ${state.currentQuestion === state.questions.length - 1 ? 'Завершить' : 'Далее'}
            </button>
        </div>
    `;
}

function selectAnswer(answerIndex) {
    const question = state.questions[state.currentQuestion];
    state.answers[question.id] = answerIndex;
    loadQuestion();
}

function prevQuestion() {
    state.currentQuestion--;
    loadQuestion();
}

function nextQuestion() {
    state.currentQuestion++;
    loadQuestion();
}

async function finishTest() {
    try {
        // Отправляем ответы
        const response = await fetch(`${API_BASE}/test/${state.currentTest}/submit`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${state.token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: state.userId,
                answers: state.answers
            })
        });
        
        if (response.ok) {
            await showTestResults();
        } else {
            throw new Error('Ошибка отправки ответов');
        }
    } catch (error) {
        alert('Ошибка завершения теста');
    }
}

async function showTestResults() {
    try {
        let correct = 0;
        let total = state.questions.length;
        
        state.questions.forEach(question => {
            if (state.answers[question.id] === question.correctAnswer) {
                correct++;
            }
        });
        
        const percentage = Math.round((correct / total) * 100);
        
        document.getElementById('testResultContent').innerHTML = `
            <div class="result">
                <p><strong>Результат:</strong> ${correct} из ${total}</p>
                <p><strong>Процент:</strong> ${percentage}%</p>
            </div>
        `;
        
        showSection('testResult');
    } catch (error) {
        alert('Ошибка загрузки результатов');
    }
}

async function viewTestResults(courseId, testId) {
    state.currentCourse = courseId;
    state.currentTest = testId;
    await showTestResults();
}

function backToTests() {
    showSection('tests');
    if (state.currentCourse) {
        loadCourseTests(state.currentCourse);
    }
}

// ========== РЕЗУЛЬТАТЫ ==========
async function loadUserResults() {
    const container = document.getElementById('resultsList');
    container.innerHTML = 'Загрузка...';
    
    try {
        const courses = await getUserCourses(state.userId);
        
        let allResults = [];
        
        for (const course of courses) {
            const tests = await getCourseTests(course.id);
            
            for (const test of tests) {
                try {
                    const response = await fetch(`${API_BASE}/test/${test.id}/user/${state.userId}`, {
                        headers: {
                            'Authorization': `Bearer ${state.token}`
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        allResults.push({
                            course: course.name,
                            test: test.name,
                            score: result.score || 0
                        });
                    }
                } catch {}
            }
        }
        
        if (allResults.length === 0) {
            container.innerHTML = '<div class="card">Нет результатов</div>';
            return;
        }
        
        container.innerHTML = allResults.map(result => `
            <div class="card">
                <h3>${result.test}</h3>
                <p>Курс: ${result.course}</p>
                <p>Оценка: ${result.score}</p>
            </div>
        `).join('');
    } catch (error) {
        container.innerHTML = '<div class="card">Ошибка загрузки</div>';
    }
}

// ========== ПРОФИЛЬ ==========
async function loadProfile() {
    const container = document.getElementById('profileContent');
    
    try {
        const user = await getUser(state.userId);
        
        container.innerHTML = `
            <div class="card">
                <h3>Профиль</h3>
                <p>Имя: ${user.name || 'Не указано'}</p>
                <p>Email: ${user.email || 'Не указан'}</p>
                <p>ID: ${user.id}</p>
                <button onclick="editProfile()">Редактировать</button>
            </div>
        `;
    } catch (error) {
        container.innerHTML = '<div class="card">Ошибка загрузки</div>';
    }
}

function editProfile() {
    document.getElementById('profileContent').innerHTML = `
        <div class="card">
            <h3>Редактирование профиля</h3>
            <input type="text" id="editName" placeholder="Имя">
            <input type="email" id="editEmail" placeholder="Email">
            <button onclick="saveProfile()">Сохранить</button>
            <button onclick="loadProfile()">Отмена</button>
        </div>
    `;
}

async function saveProfile() {
    const name = document.getElementById('editName').value;
    const email = document.getElementById('editEmail').value;
    
    try {
        await updateUser(state.userId, {name, email});
        alert('Профиль обновлен');
        loadProfile();
    } catch (error) {
        alert('Ошибка обновления профиля');
    }
}

// ========== АДМИН-ПАНЕЛЬ ==========
function loadAdminPanel() {
    const container = document.getElementById('adminContent');
    container.innerHTML = '<div class="card">Выберите действие</div>';
}

function createCourseDialog() {
    document.getElementById('courseName').value = '';
    document.getElementById('courseDesc').value = '';
    document.getElementById('createCourseModal').style.display = 'flex';
}

async function createCourse() {
    const name = document.getElementById('courseName').value;
    const description = document.getElementById('courseDesc').value;
    
    if (!name) {
        alert('Введите название курса');
        return;
    }
    
    try {
        await createCourse({name, description});
        alert('Курс создан');
        hideModal('createCourseModal');
        loadAllCourses();
    } catch (error) {
        alert('Ошибка создания курса');
    }
}

async function showAllUsers() {
    const container = document.getElementById('adminContent');
    container.innerHTML = 'Загрузка...';
    
    try {
        const users = await getAllUsers();
        
        container.innerHTML = `
            <div class="card">
                <h3>Все пользователи (${users.length})</h3>
                ${users.map(user => `
                    <div>
                        <strong>${user.name || 'Без имени'}</strong> (${user.email || 'нет email'})
                    </div>
                `).join('')}
            </div>
        `;
    } catch (error) {
        container.innerHTML = '<div class="card">Ошибка загрузки</div>';
    }
}

// ========== ВСПОМОГАТЕЛЬНЫЕ ==========
function hideModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

async function logout() {
    if (!confirm('Выйти из системы?')) return;
    
    try {
        localStorage.removeItem(SESSION_KEY);
        state = {
            status: 'unknown',
            userId: null,
            token: null,
            currentCourse: null,
            currentTest: null,
            questions: [],
            currentQuestion: 0,
            answers: {}
        };
        
        updateState('unknown');
    } catch (error) {
        alert('Ошибка выхода');
    }
}
